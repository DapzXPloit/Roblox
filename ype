--[[
    Marker Saver Script - Kompatibel dengan Delta Executor
    Disesuaikan agar berfungsi dengan baik di Delta Executor.
--]]

local Rayfield = loadstring(game:HttpGet('https://raw.githubusercontent.com/SirWeebington/Rayfield/main/Rayfield.lua'))()

local Window = Rayfield:CreateTab("Marker Saver - MarV", "icon")

local MainTab = Window:CreateSection("Main Controls")
local FilesTab = Window:CreateSection("Files")
local CheckpointsTab = Window:CreateSection("Checkpoints")

-- Variabel
local Checkpoints = {}
local CurrentCheckpoint = 1
local AutoLoopEnabled = false
local RespawnEnabled = false
local DelayTime = 0.01
local SaveFileName = "markers"

-- Fungsi untuk menampilkan notifikasi
local function SafeNotify(text)
    Rayfield:Notify({
        Title = "Marker Saver",
        Content = text,
        Duration = 5,
        Image = 4483362458,
        Actions = {
            {
                Name = "Okay!",
                Callback = function()
                    print("Notifikasi ditutup")
                end
            }
        }
    })
end

-- Fungsi untuk menyimpan checkpoint ke file (Kompatibel dengan Delta)
local function SaveToFile()
    local data = game:GetService("HttpService"):JSONEncode(Checkpoints)
    local file = io.open(SaveFileName .. ".json", "w")
    if file then
        file:write(data)
        file:close()
        SafeNotify("Checkpoint disimpan ke file: " .. SaveFileName .. ".json")
    else
        SafeNotify("Gagal menyimpan file.")
    end
end

-- Fungsi untuk memuat checkpoint dari file (Kompatibel dengan Delta)
local function LoadFromFile()
    local file = io.open(SaveFileName .. ".json", "r")
    if file then
        local data = file:read("*a")
        file:close()
        Checkpoints = game:GetService("HttpService"):JSONDecode(data)
        SafeNotify("Checkpoint dimuat dari file: " .. SaveFileName .. ".json")
        UpdateCheckpointUI()
    else
        SafeNotify("File tidak ditemukan: " .. SaveFileName .. ".json")
    end
end

-- Fungsi untuk teleportasi ke checkpoint
local function TeleportToCheckpoint(index)
    local player = game.Players.LocalPlayer
    local character = player.Character
    if character and character:FindFirstChild("HumanoidRootPart") then
        local position = Checkpoints[index]
        if position then
            character.HumanoidRootPart.CFrame = CFrame.new(position.X, position.Y, position.Z)
            SafeNotify("Teleport ke checkpoint " .. index)
        else
            SafeNotify("Checkpoint tidak valid")
        end
    else
        SafeNotify("Karakter tidak ditemukan")
    end
end

-- Fungsi untuk menghapus checkpoint
local function DeleteCheckpoint(index)
    table.remove(Checkpoints, index)
    SafeNotify("Checkpoint " .. index .. " dihapus")
    UpdateCheckpointUI()
end

-- Fungsi untuk membuat tombol checkpoint
local function CreateCheckpointButton(index)
	local CheckpointSection = CheckpointsTab:CreateSection("Checkpoint " .. index)

    CheckpointSection:CreateButton("TP", function()
        TeleportToCheckpoint(index)
    end)

    CheckpointSection:CreateButton("EDIT", function()
        -- Tambahkan logika edit di sini
        SafeNotify("Fitur Edit belum diimplementasikan")
    end)

    CheckpointSection:CreateButton("DEL", function()
        DeleteCheckpoint(index)
    end)
end

-- Fungsi untuk memperbarui UI checkpoint
local function UpdateCheckpointUI()
    -- Hapus semua section checkpoint yang ada
    for i = 1, #CheckpointsTab.Sections do
        if string.find(CheckpointsTab.Sections[i].Label, "Checkpoint") then
            CheckpointsTab:RemoveSection(CheckpointsTab.Sections[i])
        end
    end

    -- Buat ulang tombol checkpoint
    for i = 1, #Checkpoints do
        CreateCheckpointButton(i)
    end
end

-- Tombol AutoLoop
local AutoLoopButton = MainTab:CreateButton("AutoLoop ON", function()
    AutoLoopEnabled = not AutoLoopEnabled
    if AutoLoopEnabled then
        AutoLoopButton:SetLabel("AutoLoop OFF")
        SafeNotify("AutoLoop diaktifkan")
    else
        AutoLoopButton:SetLabel("AutoLoop ON")
        SafeNotify("AutoLoop dinonaktifkan")
    end
end)

-- Tombol Save CP
MainTab:CreateButton("Save CP", function()
    local player = game.Players.LocalPlayer
    local character = player.Character
    if character and character:FindFirstChild("HumanoidRootPart") then
        local position = character.HumanoidRootPart.Position
        table.insert(Checkpoints, position)
        SafeNotify("Checkpoint disimpan: " .. #Checkpoints)
        UpdateCheckpointUI()
    else
        SafeNotify("Karakter tidak ditemukan")
    end
end)

-- Tombol Delete All
MainTab:CreateButton("Delete All", function()
    Checkpoints = {}
    CurrentCheckpoint = 1
    SafeNotify("Semua checkpoint dihapus")
    UpdateCheckpointUI()
end)

-- Tombol Save File
FilesTab:CreateButton("Save File", function()
    SaveToFile()
end)

-- Tombol Load File
FilesTab:CreateButton("Load File", function()
    LoadFromFile()
end)

-- Tombol Respawn
local RespawnButton = MainTab:CreateButton("Respawn OFF", function()
    RespawnEnabled = not RespawnEnabled
    if RespawnEnabled then
        RespawnButton:SetLabel("Respawn ON")
        SafeNotify("Respawn diaktifkan")
    else
        RespawnButton:SetLabel("Respawn OFF")
        SafeNotify("Respawn dinonaktifkan")
    end
end)

-- Input Delay
MainTab:CreateInput("Ganti Delay (0.01)", function(text)
    DelayTime = tonumber(text) or 0.01
    SafeNotify("Delay diubah menjadi: " .. DelayTime)
end)

-- Inisialisasi UI
UpdateCheckpointUI()

Rayfield:LoadUI()
